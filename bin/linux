#!/bin/bash

if [ -z ${EA_SHOULD_PASTE+x} ]; then
    EA_SHOULD_PASTE=true
fi

EA_WINDOW=$( xdotool getactivewindow )

EA_APP_NAME=$( xprop -id $EA_WINDOW WM_CLASS | grep -oE '[^ ]+$' )
EA_WINDOW_TITLE=$( xprop -id $EA_WINDOW _NET_WM_NAME | cut -d" " -f3- )
EA_TGEO=$( xwininfo -id $EA_WINDOW |\
              grep 'Absolute\|Relative\|Width:\|Height:' |\
              grep -oE '[^ ]+$' )
EA_GEO=($EA_TGEO)

export EA_APP_NAME
export EA_WINDOW_TITLE
export EA_X=$(expr "${EA_GEO[0]}" - "${EA_GEO[2]}")
export EA_Y=$(expr "${EA_GEO[1]}" - "${EA_GEO[3]}")
export EA_WIDTH="${EA_GEO[4]}"
export EA_HEIGHT="${EA_GEO[5]}"

$HOME/.emacs_anywhere/bin/emacstask

if [ ! -f /tmp/eaenv ]; then
    exit 1
fi
. /tmp/eaenv
rm /tmp/eaenv

if [ "$EA_ABORT" = true ]; then
    exit 0;
fi

xclip -selection clipboard /tmp/eaclipboard
rm /tmp/eaclipboard

xdotool windowactivate --sync $EA_WINDOW

if [ "$EA_SHOULD_PASTE" = true ]; then
    xdotool key --clearmodifiers ctrl+v
fi
